<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Financial models by Soham A. Bhatia - Kelley School of Business student" />
  <meta name="theme-color" content="#000000" />
  <title>Models | Soham A. Bhatia</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="dns-prefetch" href="https://cdn.sheetjs.com" />
  <link rel="dns-prefetch" href="https://raw.githubusercontent.com" />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* PAGE-SPECIFIC STYLES - models.html */

    /* CARD STYLE */
    .model-container { display: flex; flex-direction: column; gap: 0.5rem; }

    .model-item {
      padding: 1.2rem;
      border: 1px solid transparent;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .model-item:hover {
      border-color: var(--border);
      background: var(--bg-hover);
    }

    /* The row with Ticker and Buttons */
    .model-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .item-left { display: flex; flex-direction: column; gap: 4px; }
    .ticker { font-weight: 700; color: var(--text); font-size: 1.1rem; }
    .company-name { color: var(--muted); font-size: 0.9rem; }

    /* Buttons */
    .btn-group { display: flex; gap: 10px; }

    /* EXCEL VIEWER STYLES */
    .excel-viewer {
        display: none;
        margin-top: 20px;
        border-top: 1px solid var(--border);
        padding-top: 20px;
        background: rgba(5, 5, 5, 0.5);
        padding: 20px;
        border-radius: 4px;
    }

    .tab-bar { margin-bottom: 10px; display: flex; gap: 5px; flex-wrap: wrap; }
    .tab-btn {
        font-size: 12px;
        padding: 4px 8px;
        cursor: pointer;
        background: var(--bg-input);
        border: 1px solid var(--border);
        color: var(--muted);
        font-family: inherit;
        transition: all 0.2s;
    }
    .tab-btn.active { color: var(--text); border-color: var(--muted); }

    /* The Grid */
    .grid-container {
      overflow: auto;
      max-height: 70vh; /* Use viewport height for better scaling */
      width: 100%;
      margin-top: 10px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 14px;
      color: var(--text);
      min-width: 100%;
    }

    td, th {
      border: 1px solid var(--border);
      padding: 8px 12px; /* Increased padding for better readability */
      white-space: nowrap;
      text-align: left;
    }

    /* First column (row numbers) */
    td:first-child, th:first-child {
      background: var(--bg-input);
      color: var(--muted);
      text-align: center;
      font-weight: bold;
      position: sticky;
      left: 0;
      z-index: 1;
    }

    /* Header row */
    th {
      background: var(--bg-input);
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    /* Corner cell (first header) */
    th:first-child {
      z-index: 3;
    }

    /* Right-align numbers */
    td:not(:first-child) {
      text-align: right;
    }

    /* Scrollbar styling for better UX */
    .grid-container::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    .grid-container::-webkit-scrollbar-track {
      background: var(--bg);
    }

    .grid-container::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .grid-container::-webkit-scrollbar-thumb:hover {
      background: var(--muted);
    }
  </style>
</head>

<body>
  <nav>
    <div class="nav-links">
      <a href="index.html">home</a>
      <a href="models.html" class="active">models</a>
      <a href="pitches.html">pitches</a>
    </div>
    <div class="nav-links">
      <a href="https://www.linkedin.com/in/sohambhatia06" target="_blank">linkedin</a>
      <a href="https://github.com/SohamBhatia2006" target="_blank">github</a>
      <a href="https://x.com/SohamBhatia2" target="_blank">twitter</a>
    </div>
  </nav>

  <main>
    <h1>Financial Models</h1>

    <div class="model-container">
      
      <div class="model-item">
        <div class="model-header">
            <div class="item-left">
                <span class="ticker">VZ</span>
                <span class="company-name">Verizon Communications</span>
            </div>
            <div class="btn-group">
                <button class="btn" onclick="toggleModel(this, 'https://raw.githubusercontent.com/SohamBhatia2006/financial-models/main/%24VZ.xlsm')">View</button>
                
                <a href="https://github.com/SohamBhatia2006/financial-models/raw/main/%24VZ.xlsm" class="btn">Download</a>
            </div>
        </div>

        <div class="excel-viewer">
            <div class="tab-bar"></div>
            <div class="grid-container"></div>
        </div>
      </div>

    </div>
  </main>

  <script>
    // Lazy loading for SheetJS library
    let sheetJSLoaded = false;

    async function loadSheetJS() {
      if (sheetJSLoaded || typeof XLSX !== 'undefined') return;

      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js';
        script.onload = () => {
          sheetJSLoaded = true;
          resolve();
        };
        script.onerror = () => reject(new Error('Failed to load SheetJS library'));
        document.head.appendChild(script);
      });
    }

    async function toggleModel(btn, filePath) {
      const card = btn.closest('.model-item');
      const viewer = card.querySelector('.excel-viewer');
      const grid = viewer.querySelector('.grid-container');
      const tabBar = viewer.querySelector('.tab-bar');

      // Close viewer if already open
      if (viewer.style.display === 'block') {
        viewer.style.display = 'none';
        btn.innerText = "View";
        btn.setAttribute('aria-expanded', 'false');
        return;
      }

      // Show loading state
      btn.innerText = "Loading...";
      btn.disabled = true;
      btn.setAttribute('aria-expanded', 'true');
      viewer.style.display = 'block';

      // Return early if already loaded
      if (grid.innerHTML !== "" && !grid.querySelector('.loading-text')) {
        btn.innerText = "Close";
        btn.disabled = false;
        return;
      }

      grid.innerHTML = '<span class="loading-text">Loading model...</span>';

      try {
        // Lazy load SheetJS library
        await loadSheetJS();

        // Fetch and parse Excel file
        const response = await fetch(filePath);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer);

        // Generate tab buttons for each sheet
        tabBar.innerHTML = "";
        tabBar.setAttribute('role', 'tablist');

        workbook.SheetNames.forEach((sheetName, index) => {
          const tab = document.createElement("button");
          tab.className = "tab-btn";
          tab.innerText = sheetName;
          tab.setAttribute('role', 'tab');
          tab.setAttribute('aria-label', `View ${sheetName} sheet`);
          tab.setAttribute('tabindex', '0');

          if (index === 0) {
            tab.classList.add('active');
            tab.setAttribute('aria-selected', 'true');
          } else {
            tab.setAttribute('aria-selected', 'false');
          }

          // Click handler for tab switching
          tab.onclick = () => {
            // FIX: Scope to current tabBar only (not all tabs globally)
            tabBar.querySelectorAll('.tab-btn').forEach(b => {
              b.classList.remove('active');
              b.setAttribute('aria-selected', 'false');
            });
            tab.classList.add('active');
            tab.setAttribute('aria-selected', 'true');
            grid.innerHTML = XLSX.utils.sheet_to_html(workbook.Sheets[sheetName]);
          };

          // Keyboard navigation for tabs
          tab.onkeydown = (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              tab.click();
            }
          };

          tabBar.appendChild(tab);
        });

        // Load first sheet
        grid.innerHTML = XLSX.utils.sheet_to_html(workbook.Sheets[workbook.SheetNames[0]]);
        btn.innerText = "Close";

      } catch (err) {
        console.error('Model loading error:', err);
        grid.innerHTML = `<span class="error-text">Error: ${err.message}. Ensure the GitHub repository is public and the file exists.</span>`;
        btn.innerText = "Retry";
      } finally {
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>